<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free Bible reading planner with 3 reading plans: 90-day New Testament, OT365, and Ethiopian calendar support">
    <meta name="keywords" content="Bible planner, reading plan, NT90, OT365, Ethiopian calendar, Bible study">
    
    <title>Free Bible Reading Planner - Besorah Yeshua</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="apple-touch-icon" href="assets/images/icons/icon-192.png">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/planner.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="index.html" style="text-decoration: none; color: inherit;">üìñ Besorah Yeshua</a>
            </div>
            <div class="nav-actions">
                <button id="startPlanBtn" class="btn btn-primary btn-sm">Start Plan Today</button>
                <button id="resetBtn" class="btn btn-secondary btn-sm">Reset Progress</button>
                <a href="index.html" class="btn btn-secondary btn-sm">Home</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="planner-container">
        <div class="container">
            <!-- Header -->
            <div class="planner-header">
                <h1>Free Bible Reading Planner</h1>
                <div class="calendar-toggle">
                    <button id="gregorianBtn" class="calendar-btn active">Gregorian</button>
                    <button id="ethiopianBtn" class="calendar-btn">Ethiopian</button>
                </div>
            </div>

            <!-- Stats Dashboard -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalReading">0</div>
                        <div class="stat-label">Total Days</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-content">
                        <div class="stat-value" id="completedReading">0</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <div class="stat-value" id="progressPercent">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üî•</div>
                    <div class="stat-content">
                        <div class="stat-value" id="streakDays">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
            </div>

            <!-- Reading Plan Selector -->
            <div class="plan-selector">
                <label for="readingPlan">Select Free Reading Plan:</label>
                <select id="readingPlan" class="form-select">
                    <option value="nt90">90-Day New Testament</option>
                    <option value="ot365">OT365 Challenge (1-Year OT)</option>
                    <option value="ethiopian">Ethiopian Calendar Plan</option>
                </select>
                <p class="plan-description" id="planDescription">Read through the New Testament in 90 days</p>
                <div class="plan-stats" id="planStats">
                    <span>üìñ <span id="planChapters">260</span> total chapters</span>
                    <span>‚è±Ô∏è <span id="planTime">15-25 min/day</span></span>
                    <span>üìÖ <span id="planDays">90</span> days</span>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="calendar-section">
                <div class="calendar-header">
                    <button id="prevMonth" class="nav-btn" aria-label="Previous month">‚Äπ</button>
                    <h2 id="currentMonth">Loading...</h2>
                    <button id="nextMonth" class="nav-btn" aria-label="Next month">‚Ä∫</button>
                </div>
                <div id="calendar" class="calendar-grid">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
            </div>

            <!-- Today's Reading -->
            <div class="reading-section">
                <div class="reading-header">
                    <h2>Today's Reading</h2>
                    <div class="day-info">
                        <span id="currentDay">Day 1</span>
                        <span id="currentTheme" class="theme-badge">Select a date</span>
                    </div>
                </div>
                <div id="todayReading" class="reading-card">
                    <p class="reading-placeholder">Select a date to view reading plan</p>
                </div>
                
                <div class="reading-actions">
                    <label class="reading-checkbox">
                        <input type="checkbox" id="markComplete">
                        <span>Mark today's reading as completed</span>
                    </label>
                </div>
            </div>

            <!-- Basic Notes Section -->
            <div class="notes-section">
                <h3>Study Notes & Reflection</h3>
                <div class="reflection-prompts">
                    <p class="prompt-title">Reflection Questions:</p>
                    <ul class="prompts-list">
                        <li>What does this passage reveal about God's character?</li>
                        <li>What command should I obey or truth should I believe?</li>
                        <li>How does this apply to my life today?</li>
                        <li>What sin should I confess and forsake?</li>
                        <li>Who should I share this truth with?</li>
                    </ul>
                </div>
                <textarea id="studyNotes" class="study-textarea" placeholder="Write your reflections, insights, and prayers here...&#10;&#10;Note: Your notes are saved only for this session in the free tier. For permanent note saving, upgrade to Basic Tier."></textarea>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem;">
                    üí° <strong>Tip:</strong> Notes are saved temporarily during your session but won't persist between sessions in free tier.
                </p>
            </div>

            <!-- Quick Actions -->
            <div class="actions-section">
                <h3>Quick Actions</h3>
                <div class="actions-grid">
                    <button id="jumpToday" class="action-btn">
                        <span class="action-icon">‚Ü™Ô∏è</span>
                        <span>Jump to Today</span>
                    </button>
                    <button id="viewPlan" class="action-btn">
                        <span class="action-icon">üìã</span>
                        <span>View Full Plan</span>
                    </button>
                    <button id="helpBtn" class="action-btn">
                        <span class="action-icon">‚ùì</span>
                        <span>Get Help</span>
                    </button>
                    <a href="index.html" class="action-btn">
                        <span class="action-icon">üè†</span>
                        <span>Back to Home</span>
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Besorah Yeshua. Free tier - your progress is saved locally in your browser.</p>
            <div class="footer-links">
                <a href="index.html">Home</a>
                <a href="#help">Help</a>
                <a href="https://github.com/yourusername/besorah-yeshua-bible-planner" target="_blank" rel="noopener">GitHub</a>
            </div>
        </div>
    </footer>

    <!-- Scripts - Load in correct order -->
    <script src="js/storage.js"></script>
    <script src="js/reading-plans.js"></script>
    <script src="js/calendar.js"></script>
    
    <script>
        // Initialize planner when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial plan from URL parameter if present
            const urlParams = new URLSearchParams(window.location.search);
            const planParam = urlParams.get('plan');
            if (planParam && ['nt90', 'ot365', 'ethiopian'].includes(planParam)) {
                StorageManager.setCurrentPlan(planParam);
            }
            
            // Initialize reading plans first
            ReadingPlans.init().then(() => {
                console.log('‚úÖ Reading plans loaded');
                
                // Then initialize calendar
                if (typeof CalendarManager !== 'undefined') {
                    CalendarManager.init();
                    CalendarManager.selectDate(new Date());
                    console.log('‚úÖ Calendar initialized');
                }
                
                // Setup plan selector
                setupPlanSelector();
                
                // Setup all button handlers
                setupEventHandlers();
                
                // Update statistics
                updateStatistics();
                
                console.log('‚úÖ Planner fully initialized');
            }).catch(error => {
                console.error('‚ùå Error initializing planner:', error);
                showError('Could not load reading plans. Please refresh the page.');
            });
        });
        
        function setupPlanSelector() {
            const planSelector = document.getElementById('readingPlan');
            if (!planSelector) return;
            
            // Set current plan from storage
            const currentPlan = StorageManager.getCurrentPlan();
            planSelector.value = currentPlan;
            
            // Add change listener
            planSelector.addEventListener('change', function(e) {
                const newPlan = e.target.value;
                StorageManager.setCurrentPlan(newPlan);
                
                // Reset start date when changing plans
                StorageManager.setStartDate(newPlan, new Date());
                
                // Update display
                if (typeof CalendarManager !== 'undefined') {
                    CalendarManager.selectDate(CalendarManager.selectedDate || new Date());
                }
                
                updateStatistics();
            });
        }
        
        function setupEventHandlers() {
            // Reset button
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    if (confirm('Are you sure you want to reset all progress? This will clear all your completed readings. This cannot be undone.')) {
                        StorageManager.resetAll();
                        window.location.reload();
                    }
                });
            }
            
            // Start plan button
            const startPlanBtn = document.getElementById('startPlanBtn');
            if (startPlanBtn) {
                startPlanBtn.addEventListener('click', function() {
                    const plan = document.getElementById('readingPlan').value;
                    const planName = document.getElementById('readingPlan').options[document.getElementById('readingPlan').selectedIndex].text;
                    if (confirm(`Start "${planName}" plan today? This will set today as Day 1.`)) {
                        StorageManager.setStartDate(plan, new Date());
                        if (typeof CalendarManager !== 'undefined') {
                            CalendarManager.selectDate(new Date());
                        }
                        updateStatistics();
                    }
                });
            }
            
            // Mark complete checkbox
            const markComplete = document.getElementById('markComplete');
            if (markComplete) {
                markComplete.addEventListener('change', function() {
                    const isChecked = this.checked;
                    const date = CalendarManager?.selectedDate || new Date();
                    
                    if (isChecked) {
                        StorageManager.markComplete(date);
                    } else {
                        StorageManager.unmarkComplete(date);
                    }
                    
                    if (typeof CalendarManager !== 'undefined') {
                        CalendarManager.render();
                    }
                    updateStatistics();
                });
            }
            
            // Jump to today button
            const jumpToday = document.getElementById('jumpToday');
            if (jumpToday) {
                jumpToday.addEventListener('click', function() {
                    if (typeof CalendarManager !== 'undefined') {
                        CalendarManager.currentDate = new Date();
                        CalendarManager.selectDate(new Date());
                        CalendarManager.render();
                    }
                });
            }
            
            // View plan button
            const viewPlan = document.getElementById('viewPlan');
            if (viewPlan) {
                viewPlan.addEventListener('click', function() {
                    const plan = document.getElementById('readingPlan').value;
                    const planInfo = ReadingPlans.getPlanInfo(plan);
                    alert(`You are on the "${planInfo.name}" plan.\n\n${planInfo.description}\n\nTotal: ${planInfo.days} days\nAverage: ~${planInfo.avgChaptersPerDay} chapters/day`);
                });
            }
            
            // Help button
            const helpBtn = document.getElementById('helpBtn');
            if (helpBtn) {
                helpBtn.addEventListener('click', function() {
                    alert(`Help & Tips:\n\n1. Select a reading plan from the dropdown\n2. Click "Start Plan Today" to begin from today\n3. Click on calendar dates to view readings\n4. Mark readings as complete when finished\n5. Your progress saves automatically\n\nYour data is stored locally in your browser - completely private!`);
                });
            }
            
            // Study notes auto-save (session only)
            const studyTextarea = document.getElementById('studyNotes');
            if (studyTextarea) {
                let saveTimeout;
                studyTextarea.addEventListener('input', function() {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        const notes = this.value;
                        const date = CalendarManager?.selectedDate || new Date();
                        // Save to session storage only (won't persist)
                        sessionStorage.setItem('temp_notes_' + StorageManager.formatDate(date), notes);
                    }, 500);
                });
                
                // Load session notes when date changes
                studyTextarea.addEventListener('focus', function() {
                    const date = CalendarManager?.selectedDate || new Date();
                    const savedNotes = sessionStorage.getItem('temp_notes_' + StorageManager.formatDate(date));
                    if (savedNotes && !this.value) {
                        this.value = savedNotes;
                    }
                });
            }
        }
        
        function updateStatistics() {
            if (typeof StorageManager !== 'undefined' && typeof ReadingPlans !== 'undefined') {
                const stats = StorageManager.getStatistics();
                const plan = StorageManager.getCurrentPlan();
                const planInfo = ReadingPlans.getPlanInfo(plan);
                
                // Get total readings based on plan
                const totalReadings = planInfo.days || 90;
                
                // Update DOM
                const totalEl = document.getElementById('totalReading');
                const completedEl = document.getElementById('completedReading');
                const progressEl = document.getElementById('progressPercent');
                const streakEl = document.getElementById('streakDays');
                
                if (totalEl) totalEl.textContent = totalReadings;
                if (completedEl) completedEl.textContent = stats.totalCompleted;
                if (progressEl) {
                    const percent = Math.round((stats.totalCompleted / totalReadings) * 100);
                    progressEl.textContent = `${percent}%`;
                }
                if (streakEl) streakEl.textContent = stats.currentStreak;
            }
        }
        
        function showError(message) {
            const readingContainer = document.getElementById('todayReading');
            if (readingContainer) {
                readingContainer.innerHTML = `
                    <div class="error-message" style="color: #ef4444; padding: 1rem; background: #fee2e2; border-radius: 8px;">
                        <p><strong>‚ö†Ô∏è ${message}</strong></p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>